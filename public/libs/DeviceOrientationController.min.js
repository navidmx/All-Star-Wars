var DeviceOrientationController=function(e,t){this.object=e,this.element=t||document,this.freeze=!0,this.enableManualDrag=!0,this.enableManualZoom=!0,this.useQuaternions=!0,this.deviceOrientation={},this.screenOrientation=window.orientation||0;var a,s,p,E,w,n=0,r=0,o=0,i=0,c=new THREE.Quaternion,u=1,l=1,f=new THREE.Vector2,h=new THREE.Vector2,d={AUTO:0,MANUAL_ROTATE:1,MANUAL_ZOOM:2},v=d.AUTO,m={CALIBRATE_COMPASS:"compassneedscalibration",SCREEN_ORIENTATION:"orientationchange",MANUAL_CONTROL:"userinteraction",ZOOM_CONTROL:"zoom",ROTATE_CONTROL:"rotate"},g=window.innerHeight,y=2e3*Math.tan(THREE.Math.degToRad((this.object.fov||75)/2)),b=new THREE.Quaternion,T=function(){var e;return function(t){e=arguments||{},e.type=t,e.target=this,this.dispatchEvent(e)}.bind(this)}.bind(this)();this.constrainObjectFOV=function(){E=y*(window.innerHeight/g),w=THREE.Math.radToDeg(2*Math.atan(E/2e3)),this.object.fov=w}.bind(this),this.onDeviceOrientationChange=function(e){this.deviceOrientation=e}.bind(this),this.onScreenOrientationChange=function(){this.screenOrientation=window.orientation||0,T(m.SCREEN_ORIENTATION)}.bind(this),this.onCompassNeedsCalibration=function(e){e.preventDefault(),T(m.CALIBRATE_COMPASS)}.bind(this),this.onDocumentMouseDown=function(e){this.enableManualDrag===!0&&(e.preventDefault(),v=d.MANUAL_ROTATE,this.freeze=!0,c.copy(this.object.quaternion),n=o=e.pageX,r=i=e.pageY,a=1200/window.innerWidth*.2,s=800/window.innerHeight*.2,this.element.addEventListener("mousemove",this.onDocumentMouseMove,!1),this.element.addEventListener("mouseup",this.onDocumentMouseUp,!1),T(m.MANUAL_CONTROL+"start"),T(m.ROTATE_CONTROL+"start"))}.bind(this),this.onDocumentMouseMove=function(e){o=e.pageX,i=e.pageY}.bind(this),this.onDocumentMouseUp=function(e){this.element.removeEventListener("mousemove",this.onDocumentMouseMove,!1),this.element.removeEventListener("mouseup",this.onDocumentMouseUp,!1),v=d.AUTO,this.freeze=!1,T(m.MANUAL_CONTROL+"end"),T(m.ROTATE_CONTROL+"end")}.bind(this),this.onDocumentTouchStart=function(e){switch(e.preventDefault(),e.stopPropagation(),e.touches.length){case 1:if(this.enableManualDrag!==!0)return;v=d.MANUAL_ROTATE,this.freeze=!0,c.copy(this.object.quaternion),n=o=e.touches[0].pageX,r=i=e.touches[0].pageY,a=1200/window.innerWidth*.1,s=800/window.innerHeight*.1,this.element.addEventListener("touchmove",this.onDocumentTouchMove,!1),this.element.addEventListener("touchend",this.onDocumentTouchEnd,!1),T(m.MANUAL_CONTROL+"start"),T(m.ROTATE_CONTROL+"start");break;case 2:if(this.enableManualZoom!==!0)return;v=d.MANUAL_ZOOM,this.freeze=!0,p=this.object.fov,f.set(e.touches[0].pageX,e.touches[0].pageY),h.set(e.touches[1].pageX,e.touches[1].pageY),u=l=f.distanceTo(h),this.element.addEventListener("touchmove",this.onDocumentTouchMove,!1),this.element.addEventListener("touchend",this.onDocumentTouchEnd,!1),T(m.MANUAL_CONTROL+"start"),T(m.ZOOM_CONTROL+"start")}}.bind(this),this.onDocumentTouchMove=function(e){switch(e.touches.length){case 1:o=e.touches[0].pageX,i=e.touches[0].pageY;break;case 2:f.set(e.touches[0].pageX,e.touches[0].pageY),h.set(e.touches[1].pageX,e.touches[1].pageY)}}.bind(this),this.onDocumentTouchEnd=function(e){this.element.removeEventListener("touchmove",this.onDocumentTouchMove,!1),this.element.removeEventListener("touchend",this.onDocumentTouchEnd,!1),v===d.MANUAL_ROTATE?(v=d.AUTO,this.freeze=!1,T(m.MANUAL_CONTROL+"end"),T(m.ROTATE_CONTROL+"end")):v===d.MANUAL_ZOOM&&(this.constrainObjectFOV(),v=d.AUTO,this.freeze=!1,T(m.MANUAL_CONTROL+"end"),T(m.ZOOM_CONTROL+"end"))}.bind(this);var R=function(){var e=new THREE.Quaternion,t=new THREE.Euler,n=new THREE.Quaternion,r=new THREE.Quaternion(-Math.sqrt(.5),0,0,Math.sqrt(.5)),o=0;return function(i,a,s,c){return t.set(a,i,-s,"YXZ"),e.setFromEuler(t),o=-c/2,n.set(0,Math.sin(o),0,Math.cos(o)),e.multiply(n),e.multiply(r),e}}(),M=function(){var e=new THREE.Matrix4,t=new THREE.Euler,n=new THREE.Euler,r=new THREE.Euler(-Math.PI/2,0,0,"YXZ"),o=new THREE.Matrix4,i=new THREE.Matrix4;return i.makeRotationFromEuler(r),function(r,a,s,c){return t.set(a,r,-s,"YXZ"),e.identity(),e.makeRotationFromEuler(t),n.set(0,-c,0,"YXZ"),o.identity(),o.makeRotationFromEuler(n),e.multiply(o),e.multiply(i),e}}();this.updateManualMove=function(){var e,t,m,g,T,R,M,k,y=new THREE.Euler(0,0,0,"YXZ"),E=new THREE.Quaternion,w=new THREE.Quaternion,H=1;return function(){w.copy(c),v===d.MANUAL_ROTATE?(e=(r-i)*s,t=(n-o)*a,m=THREE.Math.degToRad(e),g=THREE.Math.degToRad(t),E.set(0,Math.sin(g/2),0,Math.cos(g/2)),w.multiply(E),E.set(Math.sin(m/2),0,0,Math.cos(m/2)),w.multiply(E),T=y.setFromQuaternion(c,"YXZ").z,R=y.setFromQuaternion(w,"YXZ").z,M=y.setFromQuaternion(b||c,"YXZ").z,E.set(0,0,Math.sin((M-T)/2),Math.cos((M-T)/2)),c.multiply(E),E.set(0,0,Math.sin((M-R)/2),Math.cos((M-R)/2)),w.multiply(E),this.object.quaternion.copy(w)):v===d.MANUAL_ZOOM&&(l=f.distanceTo(h),k=u/l,H>=k&&(this.object.fov=p*k,this.object.updateProjectionMatrix()),b&&(T=y.setFromQuaternion(c,"YXZ").z,M=y.setFromQuaternion(b,"YXZ").z,E.set(0,0,Math.sin((M-T)/2),Math.cos((M-T)/2)),c.multiply(E),this.object.quaternion.copy(c)))}}(),this.updateDeviceMove=function(){var e,t,n,r,o;return function(){if(e=THREE.Math.degToRad(this.deviceOrientation.alpha||0),t=THREE.Math.degToRad(this.deviceOrientation.beta||0),n=THREE.Math.degToRad(this.deviceOrientation.gamma||0),r=THREE.Math.degToRad(this.screenOrientation||0),0!==e&&0!==t&&0!==n){if(this.useQuaternions?b=R(e,t,n,r):(o=M(e,t,n,r),b.setFromRotationMatrix(o)),this.freeze)return;this.object.quaternion.copy(b)}}}(),this.update=function(){this.updateDeviceMove(),v!==d.AUTO&&this.updateManualMove()},this.connect=function(){window.addEventListener("resize",this.constrainObjectFOV,!1),window.addEventListener("orientationchange",this.onScreenOrientationChange,!1),window.addEventListener("deviceorientation",this.onDeviceOrientationChange,!1),window.addEventListener("compassneedscalibration",this.onCompassNeedsCalibration,!1),this.element.addEventListener("mousedown",this.onDocumentMouseDown,!1),this.element.addEventListener("touchstart",this.onDocumentTouchStart,!1),this.freeze=!1},this.disconnect=function(){this.freeze=!0,window.removeEventListener("resize",this.constrainObjectFOV,!1),window.removeEventListener("orientationchange",this.onScreenOrientationChange,!1),window.removeEventListener("deviceorientation",this.onDeviceOrientationChange,!1),window.removeEventListener("compassneedscalibration",this.onCompassNeedsCalibration,!1),this.element.removeEventListener("mousedown",this.onDocumentMouseDown,!1),this.element.removeEventListener("touchstart",this.onDocumentTouchStart,!1)}};DeviceOrientationController.prototype=Object.create(THREE.EventDispatcher.prototype);
